<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>uC/OS室温计 | 胡言乱语</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="#5 uC/OS室温计
这个实验的目的是理解uC/OS II的任务调度方式，编写uC/OS II的应用程序，通过寄存器直接操纵GPIO来驱动外 部设备。
##配合课程
RTOS
##实验目的
学习uC/OS II的应用程序编写；理解如何直接操纵GPIO，体会与Linux的不同；学习单总线设备的访问方式；学习7段数码管的时分复用驱动方式。
##实验器材
###硬件
STM32F103板一块；USB串">
<meta property="og:type" content="article">
<meta property="og:title" content="uC/OS室温计">
<meta property="og:url" content="http://yoursite.com/2016/05/21/lab5/index.html">
<meta property="og:site_name" content="胡言乱语">
<meta property="og:description" content="#5 uC/OS室温计
这个实验的目的是理解uC/OS II的任务调度方式，编写uC/OS II的应用程序，通过寄存器直接操纵GPIO来驱动外 部设备。
##配合课程
RTOS
##实验目的
学习uC/OS II的应用程序编写；理解如何直接操纵GPIO，体会与Linux的不同；学习单总线设备的访问方式；学习7段数码管的时分复用驱动方式。
##实验器材
###硬件
STM32F103板一块；USB串">
<meta property="og:image" content="http://yoursite.com/./lab5pic/segmentpin.jpg">
<meta property="og:image" content="http://yoursite.com/./lab5pic/se.png">
<meta property="og:image" content="http://yoursite.com/./lab5pic/segment.png">
<meta property="og:image" content="http://yoursite.com/./lab5pic/dht22.png">
<meta property="og:image" content="http://yoursite.com/./lab5pic/codestructure.png">
<meta property="og:image" content="http://yoursite.com/./lab5pic/img_0575.jpg">
<meta property="og:image" content="http://yoursite.com/./lab1pic/fd.jpg">
<meta property="og:image" content="http://yoursite.com/./lab5pic/dht11.png">
<meta property="og:image" content="http://yoursite.com/./lab5pic/img_0572.jpg">
<meta property="og:image" content="http://yoursite.com/./lab5pic/img_0574.jpg">
<meta property="og:updated_time" content="2016-06-28T09:36:10.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="uC/OS室温计">
<meta name="twitter:description" content="#5 uC/OS室温计
这个实验的目的是理解uC/OS II的任务调度方式，编写uC/OS II的应用程序，通过寄存器直接操纵GPIO来驱动外 部设备。
##配合课程
RTOS
##实验目的
学习uC/OS II的应用程序编写；理解如何直接操纵GPIO，体会与Linux的不同；学习单总线设备的访问方式；学习7段数码管的时分复用驱动方式。
##实验器材
###硬件
STM32F103板一块；USB串">
<meta name="twitter:image" content="http://yoursite.com/./lab5pic/segmentpin.jpg">
  
    <link rel="alternate" href="/atom.xml" title="胡言乱语" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">胡言乱语</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Some technical articles written when I was intoxicated</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Søk"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-lab5" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/21/lab5/" class="article-date">
  <time datetime="2016-05-21T06:48:19.000Z" itemprop="datePublished">2016-05-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      uC/OS室温计
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#5 uC/OS室温计</p>
<p>这个实验的目的是理解uC/OS II的任务调度方式，编写uC/OS II的应用程序，通过寄存器直接操纵GPIO来驱动外 部设备。</p>
<p>##配合课程</p>
<p>RTOS</p>
<p>##实验目的</p>
<p>学习uC/OS II的应用程序编写；<br>理解如何直接操纵GPIO，体会与Linux的不同；<br>学习单总线设备的访问方式；<br>学习7段数码管的时分复用驱动方式。</p>
<p>##实验器材</p>
<p>###硬件</p>
<p>STM32F103板一块；<br>USB串口板一块；<br>面包板一块；<br>两位7段数码管（共阳）一颗；<br>360Ω 1/8W电阻2颗；<br>DHT-11 温湿度传感器1个；<br>面包线若干。</p>
<p>###软件</p>
<p>####编译软件；<br>Fritzing。<br>uvison5.</p>
<p>#实验步骤</p>
<p>设计输出方案，画连线示意图；<br>在面包板上连线，完成外部电路；<br>编写C/C++程序，测试程序和电路；</p>
<ol>
<li>测试、实现uC/OS II对GPIO的访问；</li>
<li>实现DHT-11数据的读；</li>
<li>实现以时分复用方式在四位7段数码管上依次显示0000-9999的数字；</li>
<li>用两个uc/OS II任务，一个定时读DHT-11数据，一个轮流驱动数码管，一秒一次显示当前温度和湿度。注意处理好 两个任务之间的数据共享。</li>
</ol>
<p>#连线示意图<br><img src="./lab5pic/segmentpin.jpg" alt="segment"></p>
<p><img src="./lab5pic/se.png" alt="seg"></p>
<p>以上为四位共阳数码管的引脚图片<br><img src="./lab5pic/segment.png" alt="seg"></p>
<p>以上为四位共阳数码管的接线图片，由于在fritzing中没有找到合适的stm32板子，所以将这块25pin的引脚除去下面的6个pin就当它做STM32F103了,在实体连线中，将数码管COM1-4分别连接到了C15-14，A0-A1，其余脚按照顺时针顺序连接到了STM32板的两端。<br><img src="./lab5pic/dht22.png" alt="dht"><br>如图为dht的连线图，在本次试验中，Vcc接3.3V，Dout接A8，GND接地，为了读数稳定，需要在地线和Dout间连接一个上拉电阻。</p>
<p>#实验过程</p>
<p>###UCOS的移植</p>
<p>在UCOS移植的过程中参考了网上的资料。<br>IDE环境：uvision5， <a href="">UCOS源码</a>。<br><a href="http://blog.sina.com.cn/s/blog_5d431a4b0102v654.html" target="_blank" rel="external">文章来源sina blog</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">1.新建ucos工程，选择STM32F103VE，选择CMSIS下的CORE和Device下的Startup，以及Device下的StdPeriph Drivers下的Framework，RCC，和GPIO</span><br><span class="line">2.工程中和实际目录中都新建几个目录，APP，UCOS，BSP，LIB，CPU，Output</span><br><span class="line">3.工程上右键，Options，Output页签，Select Foldeer for Objects，进入Output目</span><br><span class="line">录，点击OK</span><br><span class="line">4.把Micrium\Software\uCOS-II\Source目录中的文件拷贝到UCOS目录下，并添加到工程</span><br><span class="line">中</span><br><span class="line">5.工程Options中，C/C++页签，Include Paths,点击后面省略号可选择include目录，添</span><br><span class="line">加UCOS路径</span><br><span class="line">6.复制Micrium\Software\EvalBoards\ST\STM3210B-EVAL\RVMDK\OS-Probe目录下</span><br><span class="line">的文件app_cfg.h，os_cfg.h和includes.h到APP目录中，并在Include Paths中添加</span><br><span class="line">APP</span><br><span class="line">7.复制Micrium\Software\uCOS-II\Ports\arm-cortex-m3\Generic\RealView目录</span><br><span class="line">下的所有文件到CPU目录，添加到工程和Include Path中</span><br><span class="line">8.工程Options中，C/C++页签,Defines中添加 USE_STDPERIPH_DRIVER</span><br><span class="line">9.把RTE和RTE\Device\STM32F103VE添加进Include Paths中</span><br><span class="line">10.修改os_cfg.h文件，#define OS_APP_HOOKS_EN           1为0</span><br><span class="line">11.BSP目录下新建BSP.c文件，添加内容如下:</span><br><span class="line">#include</span><br><span class="line"></span><br><span class="line">CPU_INT32U  BSP_CPU_ClkFreq (void)</span><br><span class="line">&#123;</span><br><span class="line">    RCC_ClocksTypeDef  rcc_clocks;</span><br><span class="line"></span><br><span class="line">    RCC_GetClocksFreq(&amp;rcc_clocks);</span><br><span class="line"></span><br><span class="line">    return ((CPU_INT32U)rcc_clocks.HCLK_Frequency);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">INT32U  OS_CPU_SysTickClkFreq (void)</span><br><span class="line">&#123;</span><br><span class="line">    INT32U  freq;</span><br><span class="line"></span><br><span class="line">    freq = BSP_CPU_ClkFreq();</span><br><span class="line">    return (freq);</span><br><span class="line">&#125;</span><br><span class="line">12.复制Micrium\Software\EvalBoards\ST\STM3210B-EVAL\RVMDK\BSP目录下的bsp.h到 BSP目录中</span><br><span class="line">13.复制Micrium\Software\uC-CPU\ARM-Cortex-M3\RealView目录和Micrium\Software\uC-CPU目录下的所有文件到CPU目录下，并添加到工程和Include Path中</span><br><span class="line">14.复制Micrium\Software\uC-LIB目录下的所有.h文件到LIB目录下,并添加到Include</span><br><span class="line">Path中</span><br><span class="line">15.注释掉bsp.h中的#include    和#include    </span><br><span class="line">16.app_cfg.h文件中，修改为#define  APP_OS_PROBE_EN                         0</span><br><span class="line">17.APP目录下新建app.c文件，内容为</span><br><span class="line">#include</span><br><span class="line"></span><br><span class="line">int main()&#123;</span><br><span class="line">OSInit();</span><br><span class="line">OSStart();</span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">18.注释掉includes.h文件中的#include    和#include</span><br></pre></td></tr></table></figure>
<p>在app.c中还需要添加如下时钟中断处理函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">void SysTick_handler(void)&#123;</span><br><span class="line">	OS_CPU_SR cpu_sr;</span><br><span class="line"></span><br><span class="line">	OS_ENTER_CRITICAL();</span><br><span class="line">	OSIntNesting++;</span><br><span class="line">	OS_EXIT_CRITICAL();</span><br><span class="line"></span><br><span class="line">	OSTimeTick();</span><br><span class="line">	OSIntExit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样全部做完之后代码结构如图：<br><img src="./lab5pic/codestructure.png" alt="代码结构"></p>
<p>###GPIO的访问<br>首先，在GPIO初始化函数中，初始化所有我们需要的GPIO，当然这里是全部要用到的都初始化了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">void GPIO_Configuration(void) &#123;</span><br><span class="line">    GPIO_InitTypeDef GPIO_InitStructure;</span><br><span class="line"></span><br><span class="line">    RCC_DeInit();</span><br><span class="line">    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOC | RCC_APB2Periph_GPIOA, ENABLE);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_14</span><br><span class="line">                                | GPIO_Pin_15;</span><br><span class="line">    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;</span><br><span class="line">    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">    GPIO_Init(GPIOC, &amp;GPIO_InitStructure);</span><br><span class="line"></span><br><span class="line">    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_11</span><br><span class="line">                                | GPIO_Pin_12;</span><br><span class="line">    GPIO_Init(GPIOA, &amp;GPIO_InitStructure);</span><br><span class="line"></span><br><span class="line">    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_0</span><br><span class="line">                                | GPIO_Pin_1</span><br><span class="line">                                | GPIO_Pin_2</span><br><span class="line">                                | GPIO_Pin_3</span><br><span class="line">                                | GPIO_Pin_4</span><br><span class="line">                                | GPIO_Pin_5</span><br><span class="line">                                | GPIO_Pin_6</span><br><span class="line">                                | GPIO_Pin_7;</span><br><span class="line">    GPIO_Init(GPIOA, &amp;GPIO_InitStructure);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>随便点个小灯来测试一下吧(其实是做完后面的反过来做得这个)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GPIO_WriteBit(GPIO_C,GPIO_Pin_14,RESET);</span><br></pre></td></tr></table></figure>
<p><img src="./lab5pic/img_0575.jpg" alt=""></p>
<p>###时分复用的八位共阳数码管<br>首先为了在单独的一位数字上显示出我们想要的数字，要根据数码管每一位所对应的引脚输入正确的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">unsigned char table[10][8] =</span><br><span class="line">&#123;</span><br><span class="line">	&#123;0,	0,	1,	1,	1,	1,	1,	1&#125;,			//0</span><br><span class="line">	&#123;0,	0,	0,	0,	0,	1,	1,	0&#125;,			//1</span><br><span class="line">	&#123;0,	1,	0,	1,	1,	0,	1,	1&#125;,			//2</span><br><span class="line">	&#123;0,	1,	0,	0,	1,	1,	1,	1&#125;,			//3</span><br><span class="line">	&#123;0,	1,	1,	0,	0,	1,	1,	0&#125;,			//4</span><br><span class="line">	&#123;0,	1,	1,	0,	1,	1,	0,	1&#125;,			//5</span><br><span class="line">	&#123;0,	1,	1,	1,	1,	1,	0,	1&#125;,			//6</span><br><span class="line">	&#123;0,	0,	0,	0,	0,	1,	1,	1&#125;,			//7</span><br><span class="line">	&#123;0,	1,	1,	1,	1,	1,	1,	1&#125;,			//8</span><br><span class="line">	&#123;0,	1,	1,	0,	1,	1,	1,	1&#125;			//9</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>以上的代码分别对应了0-9的数字在数码管上的显示IO管脚电平，按照顺时针方向，从8字顶端开始为ABCDEFG，DP，而代码中从高到低对应DP，GFEDCBA。这样就可以在数码管上显示单个数字了，为了保险起见，可以给数码管接个电阻避免烧坏。</p>
<p>为了同时点亮四个数字，利用人眼的余晖效应，只要快速切换点亮每个数字，在人眼看来就像是同时亮起来的一样。这时就需要时分复用技术了。对于共阳数码管，每个数字当我们想让他亮的时候，将对应的阳极置为高电平即可，如下为选择数码管位数的函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">void digit_choose(int index)&#123;</span><br><span class="line">    BitAction v[4];</span><br><span class="line">    int i;</span><br><span class="line">    for (i=0; i&lt;4; i++)&#123;</span><br><span class="line">        if (index == i)&#123;</span><br><span class="line">            v[i] = Bit_SET;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            v[i] = Bit_RESET;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    GPIO_WriteBit(GPIOA, GPIO_Pin_11, v[0]);</span><br><span class="line">    GPIO_WriteBit(GPIOA, GPIO_Pin_12, v[1]);</span><br><span class="line">    GPIO_WriteBit(GPIOC, GPIO_Pin_14, v[2]);</span><br><span class="line">    GPIO_WriteBit(GPIOC, GPIO_Pin_15, v[3]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再在主程序中编写时分复用的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">void display(int digit)&#123;</span><br><span class="line">	static int index=-1;</span><br><span class="line">	int i;</span><br><span class="line">	int base=1000;</span><br><span class="line">	index=(index+1)%4;</span><br><span class="line">	for (i=0;i&lt;index;i++)&#123;</span><br><span class="line">		base/=10;</span><br><span class="line">	&#125;</span><br><span class="line">	digit=(digit/base)%10;</span><br><span class="line">	digit_choose(index);//选择数位</span><br><span class="line">	digit_output(digit,0);//利用定义好的管脚参数显示一个数字</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">main()&#123;</span><br><span class="line">...</span><br><span class="line">count=0;</span><br><span class="line">while(1)</span><br><span class="line">&#123;</span><br><span class="line">	count++;</span><br><span class="line">	for (int i=0;i&lt;4;i++)&#123;</span><br><span class="line">		display(count/10);//为了让数字增长不过快</span><br><span class="line">		Delay_ms(5);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样就可以在数码管上显示数字0-9999了。</p>
<p><img src="./lab1pic/fd.jpg" alt=""></p>
<p>###DHT11温湿计使用</p>
<p>DHT11是一种单总线的传感器，这意味着它的输入和输出引脚是公用的。这样就需要以精确的时间给它发送信号，它的开启模式是这样的：<br><img src="./lab5pic/dht11.png" alt="dht"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">总线空闲状态为高电平,主机把总线拉低等待DHT11响应,主机把总线拉低必须大于18毫秒,保证</span><br><span class="line">DHT11能检测到起始信号。DHT11接收到主机的开始信号后,等待主机开始信号结束,然后发送</span><br><span class="line">80us低电平响应信号.主机发送开始信号结束后,延时等待20-40us后,读取DHT11的响应信号,</span><br><span class="line">主机发送开始信号后,可以切换到输入模式,或者输出高电平均可,总线由上拉电阻拉高。</span><br></pre></td></tr></table></figure>
<p>DHT11的响应信号为将电平拉高，通常拉高80μs后就会开始传输数据。数据格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">数据格式:8bit湿度整数数据</span><br><span class="line">+8bit湿度小数数据</span><br><span class="line">+8bi温度整数数据</span><br><span class="line">+8bit温度小数数据</span><br><span class="line">+8bit校验和 数据传送正确时校验和数据等于“8bit湿度整数数据+8bit湿度小数数据+8bi温</span><br><span class="line">度整数数据+8bit温度小数数据”所得结果的末8位。</span><br></pre></td></tr></table></figure>
<p>这样就可以在GPIO A8口读到DHT11送来的数据了。<br>在程序中我们需要编写将DHT11激活的函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">void DHT11_Set(int state)&#123;//设置数据读取引脚电平</span><br><span class="line">    BitAction s;</span><br><span class="line">    if (state)&#123;</span><br><span class="line">        s = Bit_SET;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        s = Bit_RESET;</span><br><span class="line">    &#125;</span><br><span class="line">    GPIO_WriteBit(GPIOA, GPIO_Pin_8, s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void DHT11_Pin_OUT()&#123;//将数据引脚设置为主机输出并拉高</span><br><span class="line">    GPIO_InitTypeDef GPIO_InitStructure;</span><br><span class="line">    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_8;</span><br><span class="line">    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;</span><br><span class="line">    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">    GPIO_Init(GPIOA, &amp;GPIO_InitStructure);</span><br><span class="line">    DHT11_Set(1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uint8_t DHT11_Check()&#123;</span><br><span class="line">	return GPIO_ReadInputDataBit(GPIOA,GPIO_Pin_8);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void DHT11_Wait(int state)&#123;</span><br><span class="line">	while(DHT11_Check()!=state)&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void DHT11_Pin_IN()&#123;//将数据引脚设置为输入并拉高</span><br><span class="line">    GPIO_InitTypeDef GPIO_InitStructure;</span><br><span class="line">    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_8;</span><br><span class="line">    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_IN_FLOATING;</span><br><span class="line">    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;</span><br><span class="line">    GPIO_Init(GPIOA, &amp;GPIO_InitStructure);</span><br><span class="line">    DHT11_Set(1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void DHT11_Rst()&#123;</span><br><span class="line">    DHT11_Pin_OUT();//置为输出</span><br><span class="line">    DHT11_Set(0);//拉低给初始信号</span><br><span class="line">    Delay_us(25000);//延迟大于18ms</span><br><span class="line">    DHT11_Set(1);//拉高</span><br><span class="line">    Delay_us(30);</span><br><span class="line">    DHT11_Set(0);//转为输入,等待DHT11的信号</span><br><span class="line">    DHT11_Pin_IN();</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">	DHT11_Rst();</span><br><span class="line">	if (DHT11_Check()==0)&#123;</span><br><span class="line">		DHT11_Wait(1);</span><br><span class="line">		DHT11_Wait(0);//DHT拉低准备输出</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>激活后再按照传入的数据格式编写一下读取数据的函数即可读取DHT11传来的数据了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">uint8_t DHT11_Read_Byte()&#123;</span><br><span class="line">    int i, cnt;</span><br><span class="line">    uint8_t data = 0;</span><br><span class="line">    for (i=0; i&lt;8; i++)&#123;</span><br><span class="line">        cnt = 0;</span><br><span class="line">        data &lt;&lt;= 1;//每次读一位数据</span><br><span class="line">        DHT11_Wait(1);</span><br><span class="line">        while (DHT11_Check() &gt; 0)&#123;//多次读取</span><br><span class="line">            Delay_us(1);</span><br><span class="line">            cnt++;</span><br><span class="line">        &#125;</span><br><span class="line">        data |= cnt &gt; 5;</span><br><span class="line">    &#125;</span><br><span class="line">    return data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uint8_t DHT11_Read_Data(uint8_t *buf)&#123;</span><br><span class="line">    int i;</span><br><span class="line">    int cpu_sr;</span><br><span class="line">    OS_ENTER_CRITICAL();//进入critical区，避免抢占</span><br><span class="line">    DHT11_Rst();</span><br><span class="line">    if (DHT11_Check() == 0)&#123;</span><br><span class="line">        DHT11_Wait(1);</span><br><span class="line">        DHT11_Wait(0);</span><br><span class="line">        for (i=0; i&lt;5; i++)&#123;</span><br><span class="line">            buf[i] = DHT11_Read_Byte();</span><br><span class="line">        &#125;</span><br><span class="line">        DHT11_Pin_OUT();//重置数据引脚</span><br><span class="line">        OS_EXIT_CRITICAL();</span><br><span class="line">        if (buf[0] + buf[1] + buf[2] + buf[3] == buf[4])&#123;//检验校验和</span><br><span class="line">            return 1;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        OS_EXIT_CRITICAL();</span><br><span class="line">				return 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此已经可以读取DHT11的数据了。</p>
<p>###双任务执行</p>
<p>使用UCOS来执行两个任务其实非常方便，只需要使用UCOS开启两个进程即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">void gainData(void * data)</span><br><span class="line">&#123;</span><br><span class="line">	uint8_t buf[5];</span><br><span class="line">	memset(buf,0,sizeof(buf));</span><br><span class="line">	while(1)&#123;</span><br><span class="line">		if (DHT11_Read_Data(buf)==1)</span><br><span class="line">		&#123;</span><br><span class="line">			if (flag==0)</span><br><span class="line">				ledValue=buf[2];//湿度</span><br><span class="line">			else</span><br><span class="line">				ledValue=buf[0];//温度</span><br><span class="line">			flag=!flag;</span><br><span class="line">		&#125;</span><br><span class="line">		Delay_ms(1000);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">void ToSegment(void * data)</span><br><span class="line">&#123;</span><br><span class="line">	while(1)&#123;</span><br><span class="line">		display(ledValue);</span><br><span class="line">		Delay_ms(5);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">#define size 100</span><br><span class="line">int STK1[size],STK2[size];</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">	OSInit();</span><br><span class="line">	OS_CPU_SysTickInit();</span><br><span class="line">	OSTaskCreate(gainData,(void*)0,(OS_STK *)&amp;STK1,1);</span><br><span class="line">	OSTaskCreate(ToSegment,(void*)0,(OS_STK *),&amp;STK2,2);</span><br><span class="line">	OSStart();</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果为：</p>
<p><img src="./lab5pic/img_0572.jpg" alt=""><br><img src="./lab5pic/img_0574.jpg" alt=""></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2016/05/21/lab5/" data-id="cipz9ftsd0006l7fgvv6mnlzl" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/schedule/">schedule</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/uC-OS/">uC/OS</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/04/02/FlashAcadia/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">How to flash an Acadia</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Kategorier</h3>
    <div class="widget">
      <ul class="category-list"></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Acadia/">Acadia</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cpu-evaluation/">Cpu evaluation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Flashing/">Flashing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GPS/">GPS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/schedule/">schedule</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uC-OS/">uC/OS</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Acadia/" style="font-size: 10px;">Acadia</a> <a href="/tags/Cpu-evaluation/" style="font-size: 10px;">Cpu evaluation</a> <a href="/tags/Flashing/" style="font-size: 10px;">Flashing</a> <a href="/tags/GPS/" style="font-size: 10px;">GPS</a> <a href="/tags/schedule/" style="font-size: 10px;">schedule</a> <a href="/tags/uC-OS/" style="font-size: 10px;">uC/OS</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Arkiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Siste innlegg</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/05/21/lab5/">uC/OS室温计</a>
          </li>
        
          <li>
            <a href="/2016/04/02/FlashAcadia/">How to flash an Acadia</a>
          </li>
        
          <li>
            <a href="/2016/03/24/BicycleCpu/">Bicycle Cpu</a>
          </li>
        
          <li>
            <a href="/2016/03/17/GPS on your hands/">GPS on your hands</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Ding Shilun<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>